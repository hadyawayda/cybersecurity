#!/usr/bin/env py
from __future__ import annotations
import argparse, sys, json
from typing import List
from arachnida.scorpion.meta import basic_file_info, read_exif

def make_parser():
    p = argparse.ArgumentParser(prog='scorpion', add_help=False, description='Display EXIF and basic metadata for image files.')
    p.add_argument('files', nargs='+')
    p.add_argument('--json', action='store_true', help='Output JSON lines')
    p.add_argument('-h','--help', action='help', help='Show help and exit')
    return p

def main(argv: List[str]|None=None)->int:
    a = make_parser().parse_args(argv)
    rc = 0
    for f in a.files:
        try:
            rec = {'file': f, 'basic': basic_file_info(f), 'exif': read_exif(f)}
            print(json.dumps(rec, ensure_ascii=False) if a.json else _fmt(rec))
        except FileNotFoundError:
            print(f'scorpion: file not found: {f}', file=sys.stderr); rc |= 1
        except Exception as e:
            print(f'scorpion: error reading {f}: {e}', file=sys.stderr); rc |= 1
    return rc

def _fmt(rec)->str:
    lines=[f"=== {rec['file']} ==="]
    for k,v in rec['basic'].items():
        lines.append(f"{k:>12}: {v}")
    exif = rec['exif']
    if exif:
        lines.append('-- EXIF --')
        for k in sorted(exif.keys()):
            lines.append(f"{k:>20}: {exif[k]}")
    else:
        lines.append('(no EXIF)')
    return '\n'.join(lines)

if __name__=='__main__':
    raise SystemExit(main())
